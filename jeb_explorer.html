<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JEB Explorer | Shaughnessy Lab</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <style>
    :root { --primary:#fe5c00; --muted:#6b7280; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .page-header { margin: 1rem 0 1.25rem; }
    .page-header h1 { font-family: 'Playfair Display', serif; margin: 0 0 .25rem; }

    .explorer { display: grid; grid-template-columns: 280px 1fr; gap: 1rem; align-items: start; }
    .panel { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: .85rem; }
    .panel h3 { margin-top: 0; font-size: 1.05rem; }
    .filters .field { margin-bottom: .75rem; }
    .filters label { display:block; font-weight: 600; font-size:.9rem; margin-bottom:.25rem; }
    .filters input[type="search"], .filters input[type="number"], .filters select { width: 100%; padding:.45rem .55rem; border:1px solid #ddd; border-radius:6px; }
    .filters .row { display:flex; gap:.5rem; align-items:center; }
    .filters .toggle { display:inline-flex; align-items:center; gap:.45rem; }

    .toolbar { display:flex; justify-content:space-between; gap:.5rem; align-items:center; margin: .25rem 0 1rem; flex-wrap: wrap; }
    .toolbar .btn { border:1px solid var(--primary); color: var(--primary); background:#fff; padding:.4rem .6rem; border-radius:6px; cursor:pointer; font-weight:600; }
    .toolbar select { padding:.4rem .5rem; border:1px solid #ddd; border-radius:6px; }

    .results { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: .75rem; }
    .result-card { border:1px solid #eee; border-radius:10px; padding:.85rem; background:#fff; display:flex; flex-direction:column; gap:.35rem; }
    .result-card h4 { margin:.1rem 0; font-size:1rem; }
    .result-meta { font-size:.85rem; color: var(--muted); }
    .badges { display:flex; gap:.35rem; flex-wrap:wrap; }
    .badge { font-size:.7rem; border:1px solid #e5e5e5; background:#f8f8f8; padding:.1rem .4rem; border-radius:999px; }
    .empty { text-align:center; padding:2rem; border:2px dashed #eee; border-radius:12px; }

    .barlist { display:flex; flex-direction:column; gap:.35rem; }
    .barrow { display:grid; grid-template-columns: 1fr 140px 42px; gap:.5rem; align-items:center; }
    .barlabel { font-size:.85rem; color: var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .bartrack { height: 10px; background:#f2f2f2; border-radius:999px; overflow:hidden; }
    .barfill { height: 10px; background: var(--primary); border-radius:999px; }
    .barval { font-size:.85rem; color: var(--muted); text-align:right; }

    .heatgrid { display:flex; flex-wrap:wrap; gap:.35rem; }
    .heatcell { display:inline-flex; gap:.35rem; align-items:center; padding:.25rem .45rem; border-radius:999px; color:#111; font-size:.85rem; border: 1px solid rgba(0,0,0,.06); }
    .heatn { font-size:.75rem; color:#111; opacity:.85; }

    .viz { display:grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-top:1rem; }
    .viz .panel { min-height: 220px; }

    @media (max-width: 960px){
      .explorer { grid-template-columns: 1fr; }
      .results { grid-template-columns: 1fr; }
      .viz { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="logo-container" style="text-decoration: none;">
      <img src="images/logo.png" alt="Lab Logo" />
      <div class="lab-name">
        <span>Shaughnessy</span><span>Lab</span>
      </div>
    </a>
    <button class="menu-toggle" onclick="toggleMenu()">&#8801;</button>
    <nav id="mobile-nav" class="mobile-menu">
      <a href="index.html">Home</a>
      <a href="people.html">People</a>
      <a href="research.html">Research</a>
      <a href="publications.html">Publications</a>
      <a href="teaching.html">Teaching</a>
      <a href="opportunities.html">Opportunities</a>
      <a href="blog.html">Blog</a>
      <!-- Consider adding a new Resources link that includes this Explorer -->
    </nav>
  </header>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h1><span class="highlight">Journal of Experimental Biology</span> <span class="secondary">Explorer</span></h1>
        <p class="muted">Search and filter the complete JEB archive using free‑text terms (e.g., <em>lamprey</em>, <em>Ussing chamber</em>, <em>CFTR</em>) and refine by year, type, OA status, and more. Charts and the (future) author network update with your filters. <em>Last updated</em>: <span id="lastUpdated">—</span>.</p>
      </div>

      <section class="explorer" aria-label="JEB Explorer">
        <!-- Filters -->
        <aside class="filters panel" aria-label="Filters">
          <h3>Filters</h3>

          <div class="field">
            <label for="q">Search (title, abstract, authors)</label>
            <input id="q" type="search" placeholder="Try: lamprey, Ussing, CFTR, Ano1, salmon, osmoregulation" />
          </div>

          <div class="field">
            <label>Year range</label>
            <div class="row">
              <input id="ymin" type="number" placeholder="From" />
              <input id="ymax" type="number" placeholder="To" />
            </div>
          </div>

          <div class="field">
            <label for="type">Article type</label>
            <select id="type">
              <option value="">All types</option>
              <option value="journal-article">Research</option>
              <option value="review">Review</option>
              <option value="editorial">Editorial/Commentary</option>
              <option value="correction">Correction</option>
            </select>
          </div>

          <div class="field">
            <label class="toggle"><input id="oa" type="checkbox" /> Open access only</label>
          </div>

          <div class="field">
            <label for="sort">Sort</label>
            <select id="sort">
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="title-asc">Title A–Z</option>
              <option value="title-desc">Title Z–A</option>
              <option value="cited-desc">Most cited</option>
            </select>
          </div>

          <div class="field">
            <button id="reset" class="btn" type="button">Reset filters</button>
          </div>
        </aside>

        <!-- Main content: results + toolbar + charts -->
        <section class="panel" aria-label="Results">
          <div class="toolbar">
            <div class="muted"><span id="count">0</span> results</div>
            <div class="right">
              <button id="exportCsv" class="btn" type="button">Export CSV</button>
              <button id="copyLink" class="btn" type="button">Copy sharable link</button>
            </div>
          </div>

          <!-- Visualizations -->
          <div class="viz">
            <div class="panel" aria-label="Publications by year">
              <h3>Publications by Year</h3>
              <div id="chartYear" style="height: 200px;"></div>
            </div>
            <div class="panel" aria-label="Top authors">
              <h3>Top Authors (current view)</h3>
              <div id="chartAuthors" style="height: 200px;"></div>
            </div>
            <div class="panel" aria-label="Keyword/method heatmap" style="grid-column: 1 / -1;">
              <h3>Keyword / Method Heatmap</h3>
              <div id="chartHeat" style="height: 260px;"></div>
            </div>
            <div class="panel" aria-label="Author network" style="grid-column: 1 / -1;">
              <h3>Author Co‑authorship Network</h3>
              <div id="graphAuthors" style="height: 380px; display:flex; align-items:center; justify-content:center; color: var(--muted);">
                <em>Coming soon: force‑directed co‑authorship graph (D3). The rest of the explorer is fully functional.</em>
              </div>
            </div>
          </div>

          <div id="results" class="results" role="list"></div>
          <div id="noResults" class="empty" hidden>Nothing matches your filters. Try clearing the search or widening the year range.</div>


        </section>
      </section>

      <section class="panel" style="margin-top:1rem" aria-label="About this explorer">
        <h3>About this Explorer</h3>
        <p class="muted small">Data sources: Crossref (metadata), PubMed/Europe PMC (abstracts & MeSH where available), Unpaywall (open access), OpenAlex (citations). This page loads a cached JSON (auto‑updated) and performs all filtering locally in your browser.</p>
        <p class="muted small">Questions or suggestions? <a href="#" id="feedbackLink">Send feedback</a>.</p>
      </section>

    </div>
  </main>

  <footer>
    <div class="left">Department of Biology, 307 Life Sciences West, Oklahoma State University, Stillwater, OK, 74074</div>
    <div class="right">© 2025 Ciaran A. Shaughnessy</div>
  </footer>

<script>
  // ---------- globals & element refs ----------
  let minYear = 1900, maxYear = 3000;
  const els = {
    q: document.getElementById('q'),
    ymin: document.getElementById('ymin'),
    ymax: document.getElementById('ymax'),
    type: document.getElementById('type'),
    oa: document.getElementById('oa'),
    sort: document.getElementById('sort'),
    reset: document.getElementById('reset'),
    count: document.getElementById('count'),
    results: document.getElementById('results'),
    empty: document.getElementById('noResults'),
    lastUpdated: document.getElementById('lastUpdated'),
    chartYear: document.getElementById('chartYear'),
    chartAuthors: document.getElementById('chartAuthors'),
    chartHeat: document.getElementById('chartHeat'),
  };

  // ---------- filters & helpers ----------
  function currentFilters(){
    const q = (els.q.value||'').trim().toLowerCase();
    const ymin = parseInt(els.ymin.value)||minYear;
    const ymax = parseInt(els.ymax.value)||maxYear;
    const type = els.type.value;
    const oa = els.oa.checked;
    const sort = els.sort.value;
    return { q, ymin, ymax, type, oa, sort };
  }

  function applyFilters(rows, f){
    const out = rows.filter(r => {
      const y = r.published_year ?? 0;
      if (y && (y < f.ymin || y > f.ymax)) return false;
      if (f.type && r.type !== f.type) return false;

      // OA filter: handle both boolean and "true"
      const isOA = !!(r.oa && (r.oa.is_oa === true || r.oa.is_oa === 'true' || r.oa.is_oa === 1 || r.oa.is_oa === '1'));
      if (f.oa && !isOA) return false;

      if (f.q){
        const hay = [
          r.title || '',
          (r.abstract || ''),
          (r.authors || []).join(' '),
          r.doi || ''
        ].join(' ').toLowerCase();
        if (!hay.includes(f.q)) return false;
      }
      return true;
    }).sort((a,b)=>{
      switch(f.sort){
        case 'oldest': return (a.published_year||0) - (b.published_year||0);
        case 'title-asc': return (a.title||'').localeCompare(b.title||'');
        case 'title-desc': return (b.title||'').localeCompare(a.title||'');
        case 'cited-desc': return (b.citations?.count||0) - (a.citations?.count||0);
        case 'newest':
        default: return (b.published_year||0) - (a.published_year||0);
      }
    });
    return out;
  }

   // ---------- simple viz renderers (no external libraries) ----------
  function escapeHtml(s){
    return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function renderBarList(container, rows, opts){
    const { title = '', maxItems = 12 } = opts || {};
    if (!container) return;

    if (!rows.length){
      container.innerHTML = `<div class="muted small"><em>No data for current view.</em></div>`;
      return;
    }

    const maxVal = Math.max(...rows.map(r => r.value));
    const items = rows.slice(0, maxItems);

    container.innerHTML = `
      <div class="barlist">
        ${title ? `<div class="muted small" style="margin-bottom:.4rem">${escapeHtml(title)}</div>` : ``}
        ${items.map(r => {
          const pct = maxVal ? Math.round((r.value / maxVal) * 100) : 0;
          return `
            <div class="barrow">
              <div class="barlabel">${escapeHtml(r.label)}</div>
              <div class="bartrack"><div class="barfill" style="width:${pct}%"></div></div>
              <div class="barval">${r.value}</div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderYearChart(viewRows){
    // Count by year
    const counts = new Map();
    for (const r of viewRows){
      const y = r.published_year;
      if (!y) continue;
      counts.set(y, (counts.get(y) || 0) + 1);
    }
    const years = Array.from(counts.keys()).sort((a,b)=>a-b);

    // Limit for display: last 30 years with data (keeps it readable)
    const tail = years.slice(-30);
    const series = tail.map(y => ({ label: String(y), value: counts.get(y) }));

    renderBarList(els.chartYear, series, { title: 'Last 30 years in current view', maxItems: 30 });
  }

  function renderTopAuthors(viewRows){
    const counts = new Map();
    for (const r of viewRows){
      const authors = Array.isArray(r.authors) ? r.authors : [];
      for (const a of authors){
        const name = (a || '').trim();
        if (!name) continue;
        counts.set(name, (counts.get(name) || 0) + 1);
      }
    }
    const sorted = Array.from(counts.entries())
      .map(([label, value]) => ({ label, value }))
      .sort((a,b)=>b.value-a.value);

    renderBarList(els.chartAuthors, sorted, { title: 'Top 12 authors in filtered results', maxItems: 12 });
  }

  function renderKeywordHeat(viewRows){
    // Lightweight tokenization of titles+abstracts for the current view
    // Goal: show frequent terms; not a true "heatmap", but a useful term-frequency grid.
    const stop = new Set([
      'the','and','or','of','to','in','a','an','for','with','on','by','from','at','as',
      'is','are','was','were','be','been','being','that','this','these','those','it','its',
      'we','our','their','they','them','but','not','into','during','using','use','used',
      'study','effects','effect','results','result','methods','method','analysis','role'
    ]);

    const counts = new Map();
    const textOf = (r) => `${r.title || ''} ${(r.abstract || '')}`.toLowerCase();

    for (const r of viewRows){
      const txt = textOf(r);
      const tokens = txt.match(/[a-z0-9]+/g) || [];
      for (const t of tokens){
        if (t.length < 4) continue;
        if (stop.has(t)) continue;
        counts.set(t, (counts.get(t) || 0) + 1);
      }
    }

    const sorted = Array.from(counts.entries())
      .map(([term, n]) => ({ term, n }))
      .sort((a,b)=>b.n-a.n)
      .slice(0, 40);

    if (!els.chartHeat) return;

    if (!sorted.length){
      els.chartHeat.innerHTML = `<div class="muted small"><em>No keywords for current view.</em></div>`;
      return;
    }

    const maxN = Math.max(...sorted.map(x=>x.n));
    els.chartHeat.innerHTML = `
      <div class="heatgrid">
        ${sorted.map(x => {
          const alpha = maxN ? (0.15 + 0.75*(x.n/maxN)) : 0.25;
          return `<span class="heatcell" style="background: rgba(254,92,0,${alpha.toFixed(3)})" title="${escapeHtml(x.term)} (${x.n})">${escapeHtml(x.term)} <span class="heatn">${x.n}</span></span>`;
        }).join('')}
      </div>
      <div class="muted small" style="margin-top:.5rem">Top terms in titles/abstracts for the filtered results (simple frequency, stopword-filtered).</div>
    `;
  }

  function renderViz(viewRows){
    renderYearChart(viewRows);
    renderTopAuthors(viewRows);
    renderKeywordHeat(viewRows);
  }

  // ---------- RENDER (this is where the OA badge code lives) ----------
  function render(){
    const f = currentFilters();
    const out = applyFilters(window.JEB_DATA || [], f);
    els.count.textContent = out.length;
    els.results.innerHTML = '';
    els.empty.hidden = out.length !== 0;

    renderViz(out);

    out.forEach(r => {
      const card = document.createElement('article');
      card.className = 'result-card';
      card.setAttribute('role','listitem');

      const h = document.createElement('h4');
      const a = document.createElement('a');
      a.href = r.url || (r.doi ? `https://doi.org/${r.doi}` : '#');
      a.target = '_blank'; a.rel='noopener noreferrer';
      a.textContent = r.title || '(untitled)';
      h.appendChild(a);

      const meta = document.createElement('div');
      meta.className = 'result-meta';
      meta.textContent = `${r.published_year || '—'} • ${(r.type || '').replace('-', ' ')}`;

      const authors = document.createElement('div');
      authors.className = 'result-authors';
      authors.textContent = (r.authors || []).join(', ');

      const badges = document.createElement('div');
      badges.className = 'badges';

      // >>>>> OA BADGE — your snippet goes right here <<<<<
      const isOA = (r.oa && (r.oa.is_oa === true || r.oa.is_oa === 'true')) ? true : false;
      if (isOA) {
        const b = document.createElement('span');
        b.className = 'badge';
        b.textContent = 'Open Access';
        badges.appendChild(b);
      }
      // <<<<< end OA badge >>>>>

      card.appendChild(h);
      card.appendChild(meta);
      card.appendChild(authors);
      card.appendChild(badges);
      els.results.appendChild(card);
    });

    // Update URL params (shareable link)
    const p = new URLSearchParams();
    if (f.q) p.set('q', f.q);
    if (f.ymin !== minYear) p.set('ymin', f.ymin);
    if (f.ymax !== maxYear) p.set('ymax', f.ymax);
    if (f.type) p.set('type', f.type);
    if (f.oa) p.set('oa', '1');
    if (f.sort && f.sort !== 'newest') p.set('sort', f.sort);
    const newUrl = `${location.pathname}?${p.toString()}`;
    history.replaceState({}, '', newUrl);
  }

  // ---------- event wiring ----------
  [els.q, els.ymin, els.ymax, els.type, els.oa, els.sort].forEach(el => {
    if (el) el.addEventListener('input', render);
  });
  if (els.reset) els.reset.addEventListener('click', () => {
    history.replaceState({}, '', location.pathname);
    location.reload();
  });

  // ---------- robust loader (keeps your version) ----------
  async function loadData(){
    const res = await fetch('data/jeb.json?v=' + Date.now());
    if (!res.ok) throw new Error('Failed to load data/jeb.json: ' + res.status);
    const raw = await res.json();

    // array OR {items:[]}
    const items = Array.isArray(raw) ? raw : (raw.items || []);

    // normalize fields to what render() expects
    const norm = items.map(r => {
      const doi = r.DOI || r.doi || '';
      const url = r.URL || r.url || (doi ? `https://doi.org/${doi}` : '');
      return {
        title: r.title || '',
        authors: Array.isArray(r.authors) ? r.authors : [],
        published_year: Number(r.year) || Number(r.published_year) || null,
        type: r.type || '',
        doi, url,
        abstract: r.abstract || '',
        citations: r.citations || null,
        oa: r.oa || { is_oa: (r.is_oa ?? null), status: r.oa_status ?? null, url: r.oa_url ?? null },
      };
    });

    // meta timestamp (optional)
    try {
      const metaRes = await fetch('data/jeb-meta.json?v=' + Date.now());
      if (metaRes.ok) {
        const meta = await metaRes.json();
        els.lastUpdated.textContent = meta.last_updated || '—';
      } else {
        els.lastUpdated.textContent = '—';
      }
    } catch {
      els.lastUpdated.textContent = '—';
    }

    return norm;
  }

  // ---------- boot ----------
  (async function boot(){
    try {
      const DATA = await loadData();
      window.JEB_DATA = DATA;

      // init years
      const years = DATA.map(x => x.published_year).filter(y => typeof y === 'number');
      if (years.length){
        minYear = Math.min(...years);
        maxYear = Math.max(...years);
        const params = new URLSearchParams(location.search);
        els.ymin.value = params.get('ymin') ? +params.get('ymin') : minYear;
        els.ymax.value = params.get('ymax') ? +params.get('ymax') : maxYear;
      }

      render();
    } catch (e) {
      console.error(e);
      els.lastUpdated.textContent = 'Failed to load data';
      render();
    }
  })();
</script>
</body>
</html>
